image: node:latest

include:
  # For detecting secret keys and the like that are accidentally committed
  - template: Security/Secret-Detection.gitlab-ci.yml

stages:
  - install_deps
  - test
  - deploy

install_deps_backend:
  # Following https://www.addthis.com/blog/2019/05/06/how-to-speed-up-your-gitlab-ci-pipelines-for-node-apps-by-40/
  # (I *have* thought of this before)
  stage: install_deps
  cache:
    key: $CI_COMMIT_BRANCH-$CI_PROJECT_DIR # branch instead of slug, for reliability
    paths:
      - backend/api/node_modules/
  script:
    - cd backend/api
    - npm ci
  only:
    changes:
      - package-lock.json

test_backend:
  stage: test
  dependencies:
    - install_deps_backend
  cache:
    key: $CI_COMMIT_BRANCH-$CI_PROJECT_DIR
    paths:
      - backend/api/node_modules/
    policy: pull
  services:
    - name: mariadb
  variables:
    MYSQL_DATABASE: dumpster
    MYSQL_ROOT_PASSWORD: password
  script:
    - cd backend/api
    - printf "DB_HOST=mariadb\nDB_USER=root\nDB_PASSWORD=password\n" > .env
    - apt-get update && apt-get upgrade -y
    - apt-get install -y mariadb-client
    - npm run test:ci
  artifacts:
    paths:
      - backend/api/coverage

pages:
  stage: deploy
  dependencies: [] # Don't fetch cached dependencies!
  script:
    - mkdir .public
    - cp -r backend/api/coverage/lcov-report/* .public
    - mv .public public
  artifacts:
    paths:
      - public/
  only:
    - develop
    - master

deploy:
  stage: deploy
  dependencies: [] # Don't fetch cached dependencies!
  script:
    # Copy SSH credentials from CI file variables
    - mkdir ~/.ssh
    - cp "$SSH_KNOWN_HOSTS" ~/.ssh/known_hosts
    - cp "$SSH_PRIVATE_KEY" ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    # Install rsync
    - apt-get update
    - apt-get install --assume-yes rsync
    # Sync repo with remote,
    # leaving .env files and node_modules intact
    - rsync --archive --delete
            --exclude='.git'
            --exclude='node_modules'
            --exclude='.env'
            --exclude='dhparam'
            backend/ "dumpster@$SERVER_IP:dumpster"
    # Restart service
    - ssh "dumpster@$SERVER_IP" -- systemctl --user restart dumpster
  only:
    # This is currently meant for test builds,
    # so the develop branch must be included
    - develop
    - master
